// Translation Data
const translations = {
  ar: {
    // Navigation
    nav_story: 'Ù‚ØµØªÙ†Ø§',
    nav_menu: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
    nav_location: 'Ù…ÙˆÙ‚Ø¹Ù†Ø§',
    nav_home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',

    // Landing Page
    title: 'Ø§Ø±Ø¨Ø­ 100 Ø´ÙŠÙƒÙ„ Ù…Ø¹ Ù…Ø³ØªØ± ØªØ´ÙŠÙƒÙ†!',
    subtitle: 'Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… 10% + ÙØ±ØµØ© Ù„Ù„ÙÙˆØ²',
    registerNow: 'Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†',
    howItWorks: 'ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ØŸ',
    step1Title: 'Ø³Ø¬Ù„ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¨ÙˆÙ†',
    step1Desc: 'Ø§Ù…Ù„Ø£ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¨ÙˆÙ† Ø®ØµÙ… ÙØ±ÙŠØ¯ 10%',
    step2Title: 'Ø§Ø·Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',
    step2Desc: 'Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙˆØ¨ÙˆÙ†Ùƒ Ø¹Ù†Ø¯ Ø·Ù„Ø¨ ÙˆØ¬Ø¨ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©',
    step3Title: 'Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨',
    step3Desc: 'ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ØªØ¯Ø®Ù„ Ø³Ø­Ø¨ 100 Ø´ÙŠÙƒÙ„!',
    raffleTitle: 'Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ 100 Ø´ÙŠÙƒÙ„',
    raffleDesc: 'Ø³ÙŠØªÙ… Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø±Ù…Ø¶Ø§Ù† 2026',
    termsTitle: 'Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…',
    terms: [
      'ÙŠØ¬Ø¨ Ù…ØªØ§Ø¨Ø¹Ø© ØµÙØ­Ø§ØªÙ†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ´Ø§Ù„ Ù…ÙŠØ¯ÙŠØ§',
      'ÙƒÙ„ Ø´Ø®Øµ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¨ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·',
      'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ØµØ§Ù„Ø­ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø±Ù…Ø¶Ø§Ù†',
      'ÙŠØ¬Ø¨ Ø´Ø±Ø§Ø¡ ÙˆØ¬Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨',
      'Ø§Ù„Ø³Ø­Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØ¹Ø§Ø¯Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹'
    ],

    // Registration Page - New Steps
    steps_title: 'Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø±Ø¨Ø­ ğŸ†',
    steps_subtitle: 'Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨',

    step_follow_title: 'ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ´Ø§Ù„ Ù…ÙŠØ¯ÙŠØ§',
    step_follow_desc: 'Ø´Ø±Ø· Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨',
    btn_instagram: 'ØªØ§Ø¨Ø¹ Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…',
    btn_facebook: 'ØªØ§Ø¨Ø¹ ÙÙŠØ³Ø¨ÙˆÙƒ',
    social_hint: 'ÙŠØ±Ø¬Ù‰ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙØ­ØªÙŠÙ† Ù„ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„',

    step_register_title: 'Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ',
    step_register_desc: 'Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ',
    input_name_placeholder: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„',
    input_phone_placeholder: 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (059xxxxxxx)',
    btn_submit_raffle: 'ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',

    step_coupon_title: 'Ø§Ø³ØªÙ„Ù… ÙƒÙˆØ¨ÙˆÙ† 10%',
    step_coupon_desc: 'Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ ÙƒÙˆØ¯ Ø®ØµÙ… ÙÙˆØ±ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',

    step_raffle_title: 'Ø§Ø·Ù„Ø¨ ÙˆØ§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨',
    step_raffle_desc: 'Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† ÙÙŠ Ù…Ø·Ø¹Ù…Ù†Ø§ Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ <strong>100 Ø´ÙŠÙƒÙ„</strong>',

    back_home: 'â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',

    // Registration Form (Existing)
    registerTitle: 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨',
    registerSubtitle: 'Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¨ÙˆÙ†Ùƒ',
    followUs: 'ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ´Ø§Ù„ Ù…ÙŠØ¯ÙŠØ§',
    followInstagram: 'ØªØ§Ø¨Ø¹ Ø¹Ù„Ù‰ Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…',
    followFacebook: 'ØªØ§Ø¨Ø¹ Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ',
    yourName: 'Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„',
    namePlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ',
    yourPhone: 'Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ',
    phonePlaceholder: '0599123456',
    submit: 'Ø¥Ø±Ø³Ø§Ù„',
    submitting: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...',

    // Success Page
    successTitle: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰',
    yourCoupon: 'ÙƒÙˆØ¨ÙˆÙ†Ùƒ Ø§Ù„Ø®Ø§Øµ',
    saveCoupon: 'Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†!',
    discount10: 'Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ',
    raffleEntry: 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ 100 Ø´ÙŠÙƒÙ„',
    validUntil: 'ØµØ§Ù„Ø­ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø±Ù…Ø¶Ø§Ù†',
    orderNow: 'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†',
    shareWhatsApp: 'Ø´Ø§Ø±Ùƒ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨',

    // Store & Menu
    storeTitle: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
    hero_subtitle: 'ØªØ°ÙˆÙ‚ Ø§Ù„ÙØ®Ø§Ù…Ø© ÙÙŠ ÙƒÙ„ ÙˆØ¬Ø¨Ø©',
    cat_chicken: 'Ø§Ù„Ø¯Ø¬Ø§Ø¬ Ø§Ù„ÙØ§Ø®Ø±',
    cat_salads: 'Ø§Ù„Ø³Ù„Ø·Ø§Øª Ø§Ù„Ø·Ø§Ø²Ø¬Ø©',
    addToCart: 'Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©',
    viewCart: 'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©',
    cart: 'Ø§Ù„Ø³Ù„Ø©',
    cartEmpty: 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©',
    total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
    checkout: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',

    // Menu Items
    item_herb_title: 'Ø¯Ø¬Ø§Ø¬ Ø¨Ø§Ù„Ø£Ø¹Ø´Ø§Ø¨',
    item_herb_desc: 'Ù…ØªØ¨Ù„ Ø¨Ø¥ÙƒÙ„ÙŠÙ„ Ø§Ù„Ø¬Ø¨Ù„ ÙˆØ§Ù„Ø²Ø¹ØªØ± Ø§Ù„Ø¨Ø±ÙŠ ÙˆØ²ÙŠØª Ø§Ù„Ø²ÙŠØªÙˆÙ†.',
    item_peri_title: 'Ø¯Ø¬Ø§Ø¬ Ø¨ÙŠØ±ÙŠ Ø¨ÙŠØ±ÙŠ',
    item_peri_desc: 'Ù…Ø´Ù‡ÙˆØ± Ø¨Ù„Ø³Ø¹Ø© Ø­Ø±Ø§Ø±Ø© ÙˆÙ†ÙƒÙ‡Ø© Ù„ÙŠÙ…ÙˆÙ† ÙˆØ«ÙˆÙ… Ù‚ÙˆÙŠØ©.',
    item_bbq_title: 'Ø¯Ø¬Ø§Ø¬ Ø¨Ø§Ø±Ø¨ÙŠÙƒÙŠÙˆ',
    item_bbq_desc: 'Ù…Ø¯Ù‡ÙˆÙ† Ø¨ØµÙˆØµ Ø§Ù„Ø¨Ø§Ø±Ø¨ÙŠÙƒÙŠÙˆ Ø§Ù„Ù…Ø¯Ø®Ù† Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´ÙˆÙŠ.',

    item_caesar_title: 'Ø³Ù„Ø·Ø© Ø³ÙŠØ²Ø±',
    item_caesar_desc: 'Ø®Ø³ØŒ Ø®Ø¨Ø² Ù…Ø­Ù…ØµØŒ Ø¬Ø¨Ù†Ø© Ø¨Ø§Ø±Ù…ÙŠØ²Ø§Ù†ØŒ ØµÙˆØµ Ø³ÙŠØ²Ø± ÙƒØ±ÙŠÙ…ÙŠ.',
    item_greek_title: 'Ø³Ù„Ø·Ø© ÙŠÙˆÙ†Ø§Ù†ÙŠØ©',
    item_greek_desc: 'Ø®ÙŠØ§Ø±ØŒ Ø·Ù…Ø§Ø·Ù…ØŒ Ø¨ØµÙ„ØŒ Ø²ÙŠØªÙˆÙ†ØŒ Ø¬Ø¨Ù†Ø© ÙÙŠØªØ§.',

    // Notes
    notesPlaceholder: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
    itemNotePlaceholder: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„ØµÙ†Ù...',
    couponApplied: 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',
    invalidCoupon: 'ÙƒÙˆØ¨ÙˆÙ† ØºÙŠØ± ØµØ§Ù„Ø­',
    applyCoupon: 'ØªØ·Ø¨ÙŠÙ‚',
    loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
    orderSuccess: 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!',
    placeOrder: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨'
  },

  en: {
    // Navigation
    nav_story: 'Our Story',
    nav_menu: 'Menu',
    nav_location: 'Location',
    nav_home: 'Home',

    // Landing Page
    title: 'Win 100 NIS with Mister Chicken!',
    subtitle: 'Register now for a 10% discount coupon + a chance to win',
    registerNow: 'Register Now',
    howItWorks: 'How it Works?',
    step1Title: 'Register & Get Coupon',
    step1Desc: 'Fill the form to get a unique 10% discount coupon',
    step2Title: 'Order with Coupon',
    step2Desc: 'Use your coupon when ordering your favorite meal',
    step3Title: 'Enter the Raffle',
    step3Desc: 'Automatically enter the 100 NIS raffle!',
    raffleTitle: '100 NIS Raffle',
    raffleDesc: 'Draw will be held at the end of Ramadan 2026',
    termsTitle: 'Terms & Conditions',
    terms: [
      'Must follow our social media pages',
      'One coupon per person',
      'Coupon valid until end of Ramadan',
      'Must purchase at least one meal to enter',
      'Raffle is random and fair for everyone'
    ],

    // Registration Page
    steps_title: 'Steps to Win ğŸ†',
    steps_subtitle: 'Follow these simple steps to enter',
    step_follow_title: 'Follow us on Social Media',
    step_follow_desc: 'Required to enter',
    btn_instagram: 'Follow Instagram',
    btn_facebook: 'Follow Facebook',
    social_hint: 'Please follow both pages to enable registration',
    step_register_title: 'Register Your Details',
    step_register_desc: 'To get your discount code',
    input_name_placeholder: 'Full Name',
    input_phone_placeholder: 'Phone Number (059xxxxxxx)',
    btn_submit_raffle: 'Register & Get Coupon',
    step_coupon_title: 'Receive 10% Coupon',
    step_coupon_desc: 'Instant discount code appears after registration',
    step_raffle_title: 'Order & Enter Raffle',
    step_raffle_desc: 'Use coupon at our restaurant to enter <strong>100 NIS</strong> draw',
    back_home: 'â† Back to Home',

    registerTitle: 'Register for Raffle',
    registerSubtitle: 'Fill details to get your coupon',
    followUs: 'Follow Us',
    followInstagram: 'Follow Instagram',
    followFacebook: 'Follow Facebook',
    yourName: 'Full Name',
    namePlaceholder: 'Enter your name',
    yourPhone: 'Phone Number',
    phonePlaceholder: '0599123456',
    submit: 'Submit',
    submitting: 'Submitting...',

    successTitle: 'Registered Successfully! ğŸ‰',
    yourCoupon: 'Your Coupon',
    saveCoupon: 'Save this coupon!',
    discount10: '10% Discount on your order',
    raffleEntry: 'Entry to 100 NIS Raffle',
    validUntil: 'Valid until end of Ramadan',
    orderNow: 'Order Now',
    shareWhatsApp: 'Share on WhatsApp',

    // Store & Menu
    storeTitle: 'Menu',
    hero_subtitle: 'Taste Luxury in Every Meal',
    cat_chicken: 'Premium Chicken',
    cat_salads: 'Fresh Salads',
    addToCart: 'Add to Cart',
    viewCart: 'View Cart',
    cart: 'Cart',
    cartEmpty: 'Cart is empty',
    total: 'Total',
    checkout: 'Checkout',

    // Menu Items
    item_herb_title: 'Herb Chicken',
    item_herb_desc: 'Marinated with rosemary, wild thyme, and olive oil.',
    item_peri_title: 'Peri Peri Chicken',
    item_peri_desc: 'Famous for its spicy kick and strong lemon garlic flavor.',
    item_bbq_title: 'BBQ Chicken',
    item_bbq_desc: 'Brushed with smoky BBQ sauce while grilling.',

    item_caesar_title: 'Caesar Salad',
    item_caesar_desc: 'Lettuce, croutons, parmesan cheese, creamy Caesar dressing.',
    item_greek_title: 'Greek Salad',
    item_greek_desc: 'Cucumber, tomato, onion, olives, feta cheese.',

    // Notes
    notesPlaceholder: 'Order Notes (Optional)',
    itemNotePlaceholder: 'Note for item...',
    couponApplied: 'Coupon Applied',
    invalidCoupon: 'Invalid Coupon',
    applyCoupon: 'Apply',
    loading: 'Loading...',
    orderSuccess: 'Order Placed Successfully!',
    placeOrder: 'Place Order'
  }
};

// Language Manager
class LanguageManager {
  constructor() {
    this.currentLang = localStorage.getItem('language') || 'ar';
    this.updatePageDirection();
  }

  setLanguage(lang) {
    if (lang !== 'ar' && lang !== 'en') return;

    this.currentLang = lang;
    localStorage.setItem('language', lang);
    this.updatePageDirection();
    this.updateContent();
  }

  updatePageDirection() {
    document.documentElement.lang = this.currentLang;
    document.body.dir = this.currentLang === 'ar' ? 'rtl' : 'ltr';
  }

  translate(key) {
    return translations[this.currentLang][key] || key;
  }

  updateContent() {
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      element.innerHTML = this.translate(key);
    });

    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
      const key = element.getAttribute('data-i18n-placeholder');
      element.placeholder = this.translate(key);
    });

    // Update buttons
    this.updateLanguageButtons();
  }

  updateLanguageButtons() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === this.currentLang);
    });
  }

  getCurrentLang() {
    return this.currentLang;
  }
}

// Initialize Language Manager
const langManager = new LanguageManager();

// API Configuration
const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
  ? 'http://localhost:3000/api'
  : 'https://chicken-master-raffle.onrender.com/api'; // âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
const WHATSAPP_NUMBER = '+970567811812';
const INSTAGRAM_URL = 'https://www.instagram.com/chicken_master26/';
const FACEBOOK_URL = 'https://www.facebook.com/profile.php?id=61587454410215';

// Utility Functions
function showAlert(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} fade-in`;
  alert.textContent = message;

  // Create container if not exists
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container';
    document.body.appendChild(toastContainer);
  }

  toastContainer.appendChild(alert);

  setTimeout(() => {
    alert.style.opacity = '0';
    setTimeout(() => alert.remove(), 300);
  }, 5000);
}

function formatPhone(phone) {
  let clean = phone.replace(/[\s-]/g, '');
  if (clean.startsWith('0')) {
    clean = '+970' + clean.substring(1);
  } else if (clean.startsWith('970')) {
    clean = '+' + clean;
  } else if (!clean.startsWith('+')) {
    clean = '+970' + clean;
  }
  return clean;
}

async function apiRequest(endpoint, options = {}) {
  try {
    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });

    const data = await response.json();
    return { ok: response.ok, status: response.status, data };
  } catch (error) {
    console.error('API Error:', error);
    return { ok: false, error: error.message };
  }
}

// FingerprintJS Simple Alternative
function getBrowserFingerprint() {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  ctx.textBaseline = 'top';
  ctx.font = '14px Arial';
  ctx.fillText('fingerprint', 2, 2);

  const fingerprint = {
    userAgent: navigator.userAgent,
    language: navigator.language,
    platform: navigator.platform,
    hardwareConcurrency: navigator.hardwareConcurrency,
    screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    canvas: canvas.toDataURL()
  };

  return btoa(JSON.stringify(fingerprint));
}

// Cart Management
class CartManager {
  constructor() {
    this.cart = JSON.parse(localStorage.getItem('raffle_cart') || '[]');
    this.coupon = null;
    this.deliveryType = 'delivery';
  }

  addItem(item) {
    // Items with different IDs are stored separately.
    // For now, note is initialized as empty.
    const existingIndex = this.cart.findIndex(i => i.id === item.id);
    if (existingIndex >= 0) {
      this.cart[existingIndex].quantity += 1;
    } else {
      this.cart.push({ ...item, quantity: 1, note: '' });
    }
    this.save();
    this.render();
    this.openCart();
  }

  removeItem(itemId) {
    this.cart = this.cart.filter(i => i.id !== itemId);
    this.save();
    this.render();
  }

  updateQuantity(itemId, change) {
    const index = this.cart.findIndex(i => i.id === itemId);
    if (index >= 0) {
      this.cart[index].quantity += change;
      if (this.cart[index].quantity <= 0) {
        this.cart.splice(index, 1);
      }
      this.save();
      this.render();
    }
  }

  updateItemNote(itemId, note) {
    const item = this.cart.find(i => i.id === itemId);
    if (item) {
      item.note = note;
      this.save();
    }
  }

  getCart() {
    return this.cart;
  }

  getTotal() {
    return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  }

  getFinalTotal() {
    let total = this.getTotal();
    if (this.coupon && this.coupon.valid) {
      total = total * 0.9; // 10% Discount
    }
    return total;
  }

  clear() {
    this.cart = [];
    this.save();
    this.render();
  }

  save() {
    localStorage.setItem('raffle_cart', JSON.stringify(this.cart));
    this.updateCartBadge();
  }

  updateCartBadge() {
    const badge = document.querySelector('.cart-badge');
    if (badge) {
      const count = this.cart.reduce((sum, item) => sum + item.quantity, 0);
      badge.textContent = count;
      badge.style.display = count > 0 ? 'flex' : 'none';
    }
  }

  openCart() {
    const modal = document.getElementById('cartModal');
    if (modal) {
      modal.classList.add('active');
      document.body.classList.add('cart-open');
    }
  }

  closeCart() {
    const modal = document.getElementById('cartModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.classList.remove('cart-open');
    }
  }

  render() {
    const cartItemsContainer = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');

    if (!cartItemsContainer) return;

    if (this.cart.length === 0) {
      cartItemsContainer.innerHTML = `
            <div style="text-align: center; color: #777; margin-top: 3rem;">
                <i data-lucide="shopping-basket" style="width: 48px; height: 48px; opacity: 0.3; margin-bottom: 1rem;"></i>
                <p>${langManager.translate('cartEmpty')}</p>
            </div>
        `;
      if (window.lucide) lucide.createIcons();
    } else {
      cartItemsContainer.innerHTML = this.cart.map(item => `
            <div class="cart-item">
                <div class="cart-item-img">
                    <i data-lucide="${item.icon}" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="cart-item-info">
                    <div style="display:flex; justify-content:space-between;">
                        <div class="cart-item-title">${item.title}</div>
                        <div class="cart-item-price">${item.price} â‚ª</div>
                    </div>
                    
                    <div class="cart-item-controls">
                        <button class="qty-btn" onclick="cartManager.updateQuantity('${item.id}', -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="cartManager.updateQuantity('${item.id}', 1)">+</button>
                    </div>

                    <textarea 
                           class="form-input" 
                           style="margin-top: 0.5rem; padding: 0.4rem; font-size: 0.85rem; height: auto; resize: vertical;" 
                           placeholder="${langManager.translate('itemNotePlaceholder')}"
                           rows="1"
                           oninput="cartManager.updateItemNote('${item.id}', this.value)"
                    >${item.note || ''}</textarea>
                </div>
            </div>
        `).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Update Total
    let totalHTML = `${this.getTotal().toFixed(2)} â‚ª`;
    if (this.coupon && this.coupon.valid) {
      totalHTML = `
            <span style="text-decoration: line-through; color: #777; font-size: 0.9em; margin-left: 10px;">${this.getTotal().toFixed(2)}</span>
            <span style="color: #2ECC71;">${this.getFinalTotal().toFixed(2)} â‚ª</span>
        `;
    }
    if (cartTotalEl) cartTotalEl.innerHTML = totalHTML;
  }

  async validateCoupon(code) {
    if (!code) return;

    const btn = document.getElementById('applyCouponBtn');
    const msg = document.getElementById('couponMessage');
    if (btn) btn.textContent = langManager.translate('loading');

    // Client-side format check first
    if (!code.startsWith('CHICK-')) {
      this.coupon = null;
      if (msg) {
        msg.style.display = 'block';
        msg.style.color = '#E74C3C';
        msg.textContent = langManager.translate('invalidCoupon');
      }
      if (btn) btn.textContent = langManager.translate('applyCoupon');
      this.render();
      return;
    }

    try {
      const response = await apiRequest(`/registrations/coupon/${code}`);

      if (response.ok && response.data.success) {
        const couponData = response.data.data;

        if (couponData.status === 'used') {
          this.coupon = null;
          if (msg) {
            msg.style.display = 'block';
            msg.style.color = '#E74C3C';
            msg.textContent = langManager.getCurrentLang() === 'ar' ? 'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹' : 'Coupon already used';
          }
        } else if (couponData.status === 'expired') {
          this.coupon = null;
          if (msg) {
            msg.style.display = 'block';
            msg.style.color = '#E74C3C';
            msg.textContent = langManager.getCurrentLang() === 'ar' ? 'Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' : 'Coupon expired';
          }
        } else {
          // Valid
          this.coupon = { code: couponData.couponCode, valid: true };
          if (msg) {
            msg.style.display = 'block';
            msg.style.color = '#2ECC71';
            msg.textContent = langManager.translate('couponApplied') + ' (-10%)';
          }
        }
      } else {
        // Not found or error
        this.coupon = null;
        if (msg) {
          msg.style.display = 'block';
          msg.style.color = '#E74C3C';
          msg.textContent = langManager.translate('invalidCoupon');
        }
      }
    } catch (err) {
      console.error(err);
      this.coupon = null;
      if (msg) {
        msg.style.display = 'block';
        msg.style.color = '#E74C3C';
        msg.textContent = 'Error checking coupon';
      }
    }

    if (btn) btn.textContent = langManager.translate('applyCoupon');
    this.render();
  }
}

// Initialize Logic
const cartManager = new CartManager();

document.addEventListener('DOMContentLoaded', () => {
  // Buttons
  const cartBtn = document.getElementById('cartBtn');
  const closeCartBtn = document.getElementById('closeCart');
  const showCheckoutBtn = document.getElementById('showCheckoutBtn');
  const checkoutForm = document.getElementById('checkoutForm');

  // Add to Cart Logic (Event Delegation)
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-add');
    if (btn) {
      e.preventDefault();

      // Animation feedback
      btn.style.transform = 'scale(0.95)';
      setTimeout(() => btn.style.transform = '', 150);

      const itemEl = btn.closest('.menu-item');
      if (!itemEl) return;

      // Get Data
      const titleEl = itemEl.querySelector('.item-title');
      const title = titleEl ? titleEl.textContent : 'Unknown Item';

      // Generate ID
      const id = title.trim().split(/\s+/).join('_');

      // Determine price/icon
      let price = 40;
      let icon = 'utensils';

      if (title.includes('Ø³Ù„Ø·Ø©') || title.includes('Salad')) {
        price = 25;
        icon = 'salad';
      }

      cartManager.addItem({
        id, title, price, icon
      });
    }
  });

  if (cartBtn) cartBtn.addEventListener('click', () => cartManager.openCart());
  if (closeCartBtn) closeCartBtn.addEventListener('click', () => cartManager.closeCart());

  // Close cart when clicking outside (on the overlay)
  const cartModal = document.getElementById('cartModal');
  if (cartModal) {
    cartModal.addEventListener('click', (e) => {
      if (e.target === cartModal) {
        cartManager.closeCart();
      }
    });
  }

  if (showCheckoutBtn) {
    showCheckoutBtn.addEventListener('click', () => {
      if (cartManager.getCart().length === 0) {
        alert(langManager.translate('cartEmpty'));
        return;
      }
      showCheckoutBtn.style.display = 'none';
      if (checkoutForm) checkoutForm.classList.add('active');
    });
  }

  // Delivery Toggles
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const type = btn.dataset.type;
      const delInput = document.getElementById('deliveryType');
      if (delInput) delInput.value = type;
      cartManager.deliveryType = type;

      const locGroup = document.getElementById('locationGroup');
      const locInput = document.getElementById('orderLocation');

      if (locGroup && locInput) {
        if (type === 'pickup') {
          locGroup.style.display = 'none';
          locInput.removeAttribute('required');
          locInput.value = ''; // Clear value
        } else {
          locGroup.style.display = 'block';
          locInput.setAttribute('required', 'true');
        }
      }
    });
  });

  // Coupon
  const applyCouponBtn = document.getElementById('applyCouponBtn');
  if (applyCouponBtn) {
    applyCouponBtn.addEventListener('click', () => {
      const codeInput = document.getElementById('couponCode');
      const code = codeInput ? codeInput.value.trim() : '';
      cartManager.validateCoupon(code);
    });
  }

  // Submit Order
  if (checkoutForm) {
    checkoutForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('placeOrderBtn');
      btn.disabled = true;
      btn.textContent = langManager.translate('loading');

      const orderData = {
        customerName: document.getElementById('orderName').value,
        customerPhone: document.getElementById('orderPhone').value,
        customerLocation: document.getElementById('deliveryType').value === 'delivery' ?
          document.getElementById('orderLocation').value : 'Pickup',
        deliveryType: document.getElementById('deliveryType').value,
        notes: document.getElementById('orderNotes').value,
        items: cartManager.getCart(),
        couponCode: cartManager.coupon?.valid ? cartManager.coupon.code : null,
        totalBeforeDiscount: cartManager.getTotal()
      };

      const result = await apiRequest('/orders', {
        method: 'POST',
        body: JSON.stringify(orderData)
      });

      if (result.ok && result.data.success) {
        document.querySelector('.cart-content').innerHTML = `
            <div class="success-message">
                <i data-lucide="check-circle" class="success-icon" style="width: 64px; height: 64px; margin: 0 auto 1rem; display: block;"></i>
                <h2>${langManager.translate('orderSuccess')}</h2>
                <p>${langManager.translate('raffleEntry')}</p>
                <button onclick="window.location.reload()" class="btn-action" style="margin-top: 2rem;">OK</button>
            </div>
        `;
        if (window.lucide) lucide.createIcons();
        cartManager.clear();
      } else {
        alert(result.data?.message?.[langManager.getCurrentLang()] || 'Error');
        btn.disabled = false;
        btn.textContent = langManager.translate('placeOrder');
      }
    });
  }

  // Initial Render
  cartManager.updateCartBadge();
  cartManager.render();

  // Navbar Scroll Effect
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });
  }
});

// Export for usage if needed
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { langManager, apiRequest, CartManager };
}
